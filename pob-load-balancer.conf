events {
    worker_connections 1024;
}

http {
    upstream pob_backend {
        # least_conn ensures the replica with fewest active connections gets the request
        least_conn;
        
        # Docker DNS resolves to all replicas
        server pob-pod:8080 max_fails=3 fail_timeout=30s;
    }

    server {
        listen 8080;

        location / {
            proxy_pass http://pob_backend;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            
            # Important: disable connection reuse to force distribution
            proxy_buffering off;
            keepalive_timeout 0;
        }
    }
}
